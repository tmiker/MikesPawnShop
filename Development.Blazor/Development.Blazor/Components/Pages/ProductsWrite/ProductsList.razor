@page "/productsList"
@rendermode InteractiveServer
@inject IProductsWriteHttpService _writeSideHttpClient
@inject IProductsReadHttpService _readSideHttpClient
@inject NavigationManager Nav


<div class="card border-primary">

    <div class="card-header text-center bg-primary text-light">
        <h4><b>WRITE SIDE PRODUCTS</b></h4>
        <h6 class="mt-2"><i>Record Count: @_productsCount</i></h6>

    </div>

    @if (!string.IsNullOrWhiteSpace(_errorMessage))
    {
        <h4>@_errorMessage</h4>
    }
    @if (!string.IsNullOrWhiteSpace(_successMessage))
    {
        <h4>@_successMessage</h4>
    }

    <div class="card-header bg-primary text-light">
        <div class="row mt-2">
            <div class="col-2">
                <label for="aggId">Aggregate Id:</label>
                <input class="form-control" id="aggId" type="text" @bind="_aggregateIdString" @bind:after="RefreshData" />
            </div>

            <div class="col-2">
                <label for="cat">Category Filter:</label>
                <select class="form-control" id="cat" type="text" @bind="_categoryFilter" @bind:after="RefreshData">
                    <option value=""></option>
                    <option value="Astronomy">Astronomy</option>
                    <option value="Books">Books</option>
                    <option value="Computers">Computers</option>
                    <option value="Electronics">Electronics</option>
                    <option value="Music">Music</option>
                    <option value="Photography">Photography</option>
                    <option value="Sports">Sports</option>
                </select>
            </div>
            <div class="col-2">
                <label for="sort">Sort Column:</label>
                <select class="form-control" id="sort" type="text" @bind="_sortColumn" @bind:after="RefreshData">
                    <option value=""></option>
                    <option value="Name">Name</option>
                    <option value="Price">Price</option>
                </select>
            </div>

            <div class="col-2">
                <label for="pagesize">Page Size:</label>
                <input class="form-control" id="pagesize" type="number" @bind="_pageSize" @bind:after="RefreshData" />
            </div>
            <div class="col-2 offset-2">
                <a class="btn btn-warning form-control mt-4" @onclick="ClearFilters">Reset</a>
            </div>

        </div>
    </div>

    <div class="card-body">
        <div class="row">
            <div class="col-2">
                <a class="btn btn-danger form-control" @onclick="PurgeData">Purge Data</a>
            </div>
            <div class="col-2 offset-6">
                <a class="btn btn-warning form-control" @onclick="ClearMessages">Clear Messages</a>
            </div>
            <div class="col-2">
                <a class="btn btn-success form-control" @onclick="AddProduct">Add Product</a>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-12">

                @if (_products is not null)
                {
                    <table class="table table-sm table-bordered text-center">
                        <thead class="bg-primary text-light">
                            <tr>
                                <th>Id</th>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Price</th>
                                <th>Currency</th>
                                <th>Status</th>
                                <th>Images</th>
                                <th>Documents</th>
                                <th>Version</th>
                                <th></th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var product in _products)
                            {
                                <tr>
                                    <td>@product.Id</td>
                                    <td>@product.Name</td>
                                    <td>@product.Category</td>
                                    <td>@product.Price</td>
                                    <td>@product.Currency</td>
                                    <td>@product.Status</td>
                                    <td>@product.Images?.Count</td>
                                    <td>@product.Documents?.Count</td>
                                    <td>@product.Version</td>
                                    <td>
                                        <a class="btn btn-primary" @onclick="() => Detail(product.Id.ToString())">Detail</a>
                                    </td>

                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {

                }

            </div>
        </div>

        <div class="row m2">
            @if (_pagingData is not null)
            {
                <div class="col-2 offset-2">
                    <span class="text-primary">Page @_pagingData.CurrentPage of @_pagingData.TotalPageCount</span>
                </div>
                <div class="col-1">
                    <a class="btn btn-sm btn-primary form-control" @onclick="PageBackward">Back</a>
                </div>
                <div class="col-1">
                    <a class="btn btn-sm btn-primary form-control" @onclick="PageForward">Fwd</a>
                </div>
                <div class="col-2 offset-1">
                    <span class="text-primary">Page Size: @_pagingData.PageSize</span>
                </div>
                <div class="col-2">
                    <span class="text-primary">Total Items: @_pagingData.TotalItemCount</span>
                </div>
            }
        </div>

    </div>

    <div class="card-body text-center bg-primary text-light">
        <h5><b><i>Be good to your pets!</i></b></h5>
    </div>

</div>

@if (_addProductDTO is not null)
{
    <AddProductModal ModalTitle="Add Product" SubmitButtonTitle="Add Product" AddNewProductDTO="@_addProductDTO" Submit="SubmitAddProduct" CancelAddProduct="CancelAddProduct" />
}

@if (_purgeDataDTO is not null)
{
    <PurgeDataConfirmationModal ModalTitle="Confirm Purge Data" SubmitButtonTitle="Purge Data" PurgeDataDTO="@_purgeDataDTO" Submit="SubmitPurgeData" CancelPurgeData="CancelPurgeData" />
}

@code {

    // [CascadingParameter(Name = "SelectedProduct")]
    // public ProductSummaryDTO? SelectedProduct { get; set; }

    private List<ProductSnapshotDTO>? _products;

    private string? _aggregateIdString = null;
    private string? _categoryFilter = null;
    private string? _sortColumn = null;
    private int _minVersion = 0;
    private int _maxVersion = Int32.MaxValue;

    private int _pageNumber = 1;
    private int _pageSize = 10;
    private PaginationMetadata? _pagingData;

    private int _productsCount;

    private string? _errorMessage;
    private string? _successMessage;
    private void ClearMessages()
    {
        _errorMessage = null;
        _successMessage = null;
    }

    private void Detail(string aggregateId) => Nav.NavigateTo($"productDetail/{aggregateId}");

    //// ****************** ADD AND REMOVE IMAGES AND DOCUMENTS START *******************

    private CancellationTokenSource? _cancellationTokenSource;
 

    //// ****************** ADD PRODUCT *****************
    private AddProductDTO? _addProductDTO = null;
    private void AddProduct() => _addProductDTO = new AddProductDTO();
    private void CancelAddProduct() => _addProductDTO = null;
    private async Task SubmitAddProduct()
    {
        _cancellationTokenSource = new CancellationTokenSource();
        if (_addProductDTO is null) return;
        var result = await _writeSideHttpClient.AddProductAsync(_addProductDTO!, _cancellationTokenSource.Token);
        if (result.IsSuccess) _successMessage = "Successfully added product.";
        // need to get product from id on write side and add a dto for it
        else _errorMessage = result.ErrorMessage;
        _cancellationTokenSource = new CancellationTokenSource();
        _addProductDTO = null;
        await RefreshData();
    }

    //// ****************** PURGE DATA *****************
    private PurgeDataDTO? _purgeDataDTO = null;
    private void PurgeData() => _purgeDataDTO = new PurgeDataDTO();
    private void CancelPurgeData() => _purgeDataDTO = null;
    private async Task SubmitPurgeData()
    {
        _cancellationTokenSource = new CancellationTokenSource();
        if (_purgeDataDTO is null) return;
        var result = await _writeSideHttpClient.PurgeDataAsync(_purgeDataDTO, _cancellationTokenSource.Token);
        if (result.IsSuccess) _successMessage = "Successfully purged data.";
        else _errorMessage = result.ErrorMessage;
        _cancellationTokenSource = new CancellationTokenSource();
        _purgeDataDTO = null;
        await RefreshData();
    }

    private async Task ClearFilters()
    {
        _aggregateIdString = null;
        _categoryFilter = null;
        _sortColumn = null;

        await RefreshData();
    }

    private async Task PageForward()
    {
        if (_pagingData is null || _pageNumber >= _pagingData.TotalPageCount) return;
        _pageNumber = _pageNumber + 1;
        await RefreshData();
    }

    private async Task PageBackward()
    {
        if (_pageNumber <= 1) return;
        _pageNumber = _pageNumber - 1;
        await RefreshData();
    }

    private async Task RefreshData()
    {
        // var result = await _writeSideHttpClient.GetPagedProductSnapshotsAsync(_aggregateIdString, _minVersion, _maxVersion, _pageNumber, _pageSize);
        var result = await _writeSideHttpClient.GetPagedAndFilteredProductSnapshotsAsync(_aggregateIdString, _categoryFilter, _sortColumn, _pageNumber, _pageSize);
        if (result.IsSuccess)
        {
            _products = result.ProductSnapshots is null ? new List<ProductSnapshotDTO>() : result.ProductSnapshots.ToList();
            _pagingData = result.PagingData;
            _productsCount = _products.Count;

            // if (result.ProductSnapshots is not null && result.ProductSnapshots.Any())
            // {
            //     _products = result.ProductSnapshots.ToList();
            //     _pagingData = result.PagingData;
            //     _productsCount = _products.Count;
            // }
        }
        else Console.WriteLine(result.ErrorMessage);
    }

    protected override async Task OnAfterRenderAsync(bool isFirstRender)
    {
        if (isFirstRender)
        {
            // var result = await _writeSideHttpClient.GetPagedProductSnapshotsAsync(_aggregateIdString, _minVersion, _maxVersion, _pageNumber, _pageSize);
            var result = await _writeSideHttpClient.GetPagedAndFilteredProductSnapshotsAsync(_aggregateIdString, _categoryFilter, _sortColumn, _pageNumber, _pageSize);
            if (result.IsSuccess)
            {
                _products = result.ProductSnapshots is null ? new List<ProductSnapshotDTO>() : result.ProductSnapshots.ToList();
                _pagingData = result.PagingData;
                _productsCount = _products.Count;
                
                // if (result.ProductSnapshots is not null && result.ProductSnapshots.Any())
                // {
                //     _products = result.ProductSnapshots.ToList();
                //     _pagingData = result.PagingData;
                //     _productsCount = _products.Count;
                // }
            }
            else Console.WriteLine(result.ErrorMessage);
            this.StateHasChanged();
        }
    }

    
}


    @*
        @if (_addImageDTO is not null)
    {
        <div class="card-header bg-primary text-light">

            <div class="row mt-2">
                <div class="col-6 offset-3 text-center">
                    <h5><b>Add Product Image</b></h5>
                </div>
            </div>
            <div class="row mt-2">
                <EditForm Model="_addImageDTO" OnValidSubmit="SubmitAddImage" FormName="AddProductImageForm">
                    <DataAnnotationsValidator />
                    
                    <div class="col-12 text-center">
                        <div class="form-group row">
                            <div class="col-3">
                                <label for="productId">Product Id:</label>
                            </div>
                            <div class="col-9">
                                <InputText inert class="form-control" id="productId" @bind-Value="@_addImageDTO.ProductId" />
                                <ValidationMessage For="@(() => _addImageDTO.ProductId)" />
                            </div>
                        </div>
                        <div class="form-group row">
                            <div class="col-3 text-center">
                                <label for="name">Name:</label>
                            </div>
                            <div class="col-9">
                                <InputText class="form-control" id="name" @bind-Value="@_addImageDTO.Name" />
                                <ValidationMessage For="@(() => _addImageDTO.Name)" />
                            </div>
                        </div>
                        <div class="form-group row">
                            <div class="col-3 text-center">
                                <label for="caption">Caption:</label>
                            </div>
                            <div class="col-9">
                                <InputText class="form-control" id="caption" @bind-Value="@_addImageDTO.Caption" />
                                <ValidationMessage For="@(() => _addImageDTO.Caption)" />
                            </div>
                        </div>
                        <div class="form-group row">
                            <div class="col-3 text-center">
                                <label for="seq">Sequence Number:</label>
                            </div>
                            <div class="col-9">
                                <InputNumber class="form-control" id="seq" @bind-Value="@_addImageDTO.SequenceNumber" />
                                <ValidationMessage For="@(() => _addImageDTO.SequenceNumber)" />
                            </div>
                        </div>
                        <div class="form-group row">
                            <div class="col-3 text-center">
                                <label for="desiredfilename">Desired File Name:</label>
                            </div>
                            <div class="col-9">
                                <InputText class="form-control" id="desiredfilename" @bind-Value="@_addImageDTO.BlobFileName" />
                                <ValidationMessage For="@(() => _addImageDTO.BlobFileName)" />
                            </div>
                        </div>
                        <div class="form-group row">
                            <div class="col-3 text-center">
                                <label for="file">Image to Add:</label>
                            </div>
                            <div class="col-9">
                                <InputFile class="form-control" typeof="file" id="file" OnChange="@OnImageInputFileChange" />
                                <ValidationMessage For="@(() => _addImageDTO.ImageBlob)" />
                            </div>
                        </div>

                        <br />
                        <div class="row">
                            <div class="col-4 offset-3">
                                <button class="btn btn-success form-control" type="submit">Submit</button>
                            </div>
                            <div class="col-4 offset-1">
                                <a class="btn btn-primary form-control" @onclick="CancelAddImage">Cancel</a>
                            </div>
                        </div>
                    </div>
                </EditForm>
            </div>


        </div>

    }
    *@