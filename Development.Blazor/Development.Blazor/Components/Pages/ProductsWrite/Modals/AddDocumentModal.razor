
<div class="modal fade show d-block" tabindex="-1" role="dialog">
    <div class="modal-backdrop fade show" @onclick="Cancel"></div>
    <div class="modal-dialog modal-lg" style="z-index: 1050">
        <!-- Pop it above the backdrop -->
        <div class="modal-content rounded-3 border">

            <div class="modal-header bg-primary text-light">
                <h5>@ModalTitle</h5>
            </div>

            <div class="modal-body">

                @if (!string.IsNullOrEmpty(_allowedFileTypeError))
                {
                    <h4 class="text-danger">ERROR: @_allowedFileTypeError</h4>
                    <a class="btn btn-success" @onclick="ClearFileTypeError">Clear</a>
                }

                <EditForm Model="@DocumentToAdd" OnValidSubmit="Submit" FormName="AddDocumentModalForm">
                    <DataAnnotationsValidator />
                    @if (DocumentToAdd != null)
                    {
                        <div class="form-group row">
                            <div class="col-3">
                                <label for="productId">Product Id:</label>
                            </div>
                            <div class="col-9">
                                <InputText inert class="form-control" id="productId" @bind-Value="@DocumentToAdd.ProductId" />
                                <ValidationMessage For="@(() => DocumentToAdd.ProductId)" />
                            </div>
                        </div>
                        <div class="form-group row">
                            <div class="col-3 ">
                                <label for="name">Name:</label>
                            </div>
                            <div class="col-9">
                                <InputText class="form-control" id="name" @bind-Value="@DocumentToAdd.Name" />
                                <ValidationMessage For="@(() => DocumentToAdd.Name)" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-3">
                                <label class="label" for="title">Title:</label>
                            </div>
                            <div class="col-9">
                                <InputText class="form-control " id="title" @bind-Value="@DocumentToAdd.Title" />
                            </div>
                        </div>
                        <ValidationMessage For="@(() => DocumentToAdd.Title)" />
                        <div class="form-group row">
                            <div class="col-3 ">
                                <label for="seq">Sequence Number:</label>
                            </div>
                            <div class="col-9">
                                <InputNumber class="form-control" id="seq" @bind-Value="@DocumentToAdd.SequenceNumber" />
                                <ValidationMessage For="@(() => DocumentToAdd.SequenceNumber)" />
                            </div>
                        </div>
                        <div class="form-group row">
                            <div class="col-3 ">
                                <label for="desiredfilename">Desired File Name:</label>
                            </div>
                            <div class="col-9">
                                <InputText class="form-control" id="desiredfilename" @bind-Value="@DocumentToAdd.BlobFileName" />
                                <ValidationMessage For="@(() => DocumentToAdd.BlobFileName)" />
                            </div>
                        </div>
                        <div class="form-group row">
                            <div class="col-3">
                                <label for="file">Document:</label>
                            </div>
                            <div class="col-9">
                                <InputFile class="form-control" typeof="file" id="files" OnChange="@OnDocumentInputFileChange" /> 
                                <ValidationMessage For="@(() => DocumentToAdd.DocumentBlob)" />
                            </div>
                        </div>

                        <br />

                        <div class="row mt-2">
                            <div class="col-4 offset-3">
                                <button class="btn button-primary form-control" @onclick="Cancel">Cancel</button>
                            </div>
                            @if (DocumentToAdd.DocumentBlob is not null)
                            {
                                <div class="col-4 offset-1">
                                    <button class="btn button-success form-control" type="submit">Submit</button>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="row">
                            <div class="col-12">
                                <h5 class="text-danger"><b><i>Error: No Task object provided.</i></b></h5>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-4 offset-4 text-center">
                                <button class="btn btn-primary form-control" @onclick="Cancel">Cancel</button>
                            </div>
                        </div>
                    }
                </EditForm>
            </div>
            <div class="modal-footer bg-primary text-light">
                <p>Footer</p>
            </div>
        </div>
    </div>
</div>

@code {
    private string? _allowedFileTypeError;

    private void ClearFileTypeError() 
    {
        // DocumentToAdd!.DocumentBlob = null;
        _allowedFileTypeError = null;
    }

    [Parameter]
    public AddDocumentDTO? DocumentToAdd { get; set; }

    [Parameter]
    public string? ModalTitle { get; set; }

    [Parameter]
    public EventCallback Submit { get; set; }

    [Parameter]
    public string AddButtonTitle { get; set; } = "Add";

    [Parameter]
    public EventCallback Cancel { get; set; }

    private string[] _allowedDocumentFileTypes = new string[] { ".doc", ".docx", ".xls", ".xlsx", ".pdf", ".txt" };

    private async Task OnDocumentInputFileChange(InputFileChangeEventArgs e)
    {
        try
        {
            var files = e.GetMultipleFiles();
            if (files.Any()) DocumentToAdd!.DocumentBlob = files[0]; // e.File;

        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
        }
    }
}
